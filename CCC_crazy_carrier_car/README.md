# 小车程序说明

## 概述
- 采用STM32F407vet6核心板作为主控
- 采用STMCubeMX生成工程，用keil5进行编译和下载
- 包含：步进电机驱动、舵机驱动、屏幕显示、树莓派通信

## 工程结构和使用说明

### 整体结构
- Core:主程序代码main.c所在，我们所修改的就只有main.c和main.h
- Drivers:驱动代码所在，包括各种外设的驱动代码,不需要修改
- MDK-ARM:keil工程文件所在，不需要修改
- communication:包括串口通信相关和定时器中断相关（串口屏、视觉联调等主要代码所在）
- motor_control: 步进电机的驱动库，提供了电机的控制函数，部分电机控制相关的参数在这里设置（如电机的转速、加速度、移动位置等）
- MPU6050: 陀螺仪的驱动库，提供了陀螺仪的初始化函数和读取函数,目前未使用
- screen: 显示屏的驱动库，用的串口屏，只需要用printf调用串口发送数据即可
- sensor: 传感器的驱动库，暂无内容
- servo: 舵机的驱动库，待完善
- template: .c和.h文件的模板，用于新建文件时参考



***下面是主要的程序所在的文件***

#### main.c
- 首先初始化各个外设(串口、中断、等待电机初始化等)
- 进行预先设定好的程序，如行走、转弯、识别、抓取等。
- 在各个动作进行的过程中，借助一些全局变量来进行状态的判断和传输（比如当到位时用串口给树莓派发消息，树莓派则开始进行视觉识别）

#### my_timer.c
- 定时器控制的原理即采用定时器中断，每隔一段时间执行一次中断函数，中断函数中进行一些操作，如电机的控制、传感器的读取等。
- 电机的微调控制在此


#### my_usart.c
- 串口的通信在此，包括串口屏、树莓派、电机的通信

#### motor.c
- 电机的控制函数在此，主要是电机的位置控制、速度控制

#### my_servo.c
- 舵机的控制函数在此，待完善


## 控制思路和逻辑

### 整体的控制逻辑梳理
**综述：** 总体就是在main函数中执行各个动作，在定时器中断(`my_timer.c`)和串口相关(`my_usart.c`)中进行串口的通信与数据的传输等


#### 比赛整体流程

##### 启动
- 展开：（这个仍需讨论，看启动时需不需要满足300*300mm的尺寸要求）
- 出库：需要测试出库的角度、是否需要转向，是否需要陀螺仪辅助定位和初始化等

##### 二维码识别和任务获得
- 前往二维码：需要测试从完成出库的位置到二维码的位置的距离，前往二维码识别区域（此处无需精确定位）
- 二维码识别：需要发送开始识别的信号给树莓派，开始识别并返回识别的结果，测试识别的速度和准确度，在屏幕上显示顺序码

##### 原料区搬运（第一批）
- 前往原料区：需要测试从二维码到原料区的距离，还需要整车转向，夹爪朝向原料盘（或者可以考虑出库时就转向）
- 原料盘精确定位：根据视觉识别，确定原料盘的中心，并调整车的位置
- 颜色识别与夹取：根据任务的顺序识别原料的颜色，当对应颜色到位时，树莓派发送信息，夹爪开始夹取，执行完毕后继续识别并夹取（此处需要考虑单次夹取和放置并归位的时间，尽量做到连续夹取）

##### 粗加工区搬运和夹取（第一批）
- 前往粗加工区：三个物料夹取完后，前往粗加工区，一样需要测试时间和距离
- 粗加工区精确定位：到达大致位置时，借助视觉进行微调定位
- 放置原料：按照顺序放置（视底盘旋转的情况和电机移动的情况决定是原地一次性完成三个物料的放置还是移动分别完成，还要考虑是否需要视觉辅助闭环反馈校正）

##### 暂存区放置（第一批）
- 夹取：把粗加工区的物料夹取，放置在载物盘上
- 前往暂存区：需要测试距离，还要考虑转向等问题
- 暂存区识别定位：到达大致位置后借助视觉进行微调
- 放置原料：按照顺序放置（要考虑的同上）
  
##### 原料区搬运（第二批）
- 返回原料区：从暂存区返回原料区，需要测试移动的距离，还需要整车的旋转等
- 原料盘精确定位：根据视觉识别，确定原料盘的中心，并调整车的位置
- 颜色识别与夹取：根据任务的顺序识别原料的颜色，当对应颜色到位时，树莓派发送信息，夹爪开始夹取，执行完毕后继续识别并夹取（此处需要考虑单次夹取和放置并归位的时间，尽量做到连续夹取）

##### 粗加工区搬运和夹取（第二批）
- 前往粗加工区：三个物料夹取完后，前往粗加工区，一样需要测试时间和距离
- 粗加工区精确定位：到达大致位置时，借助视觉进行微调定位
- 放置原料：按照顺序放置（要求同上）

##### 暂存区放置（第二批）
- 夹取：把粗加工区的物料夹取，放置在载物盘上
- 前往暂存区：需要测试距离，还要考虑转向等问题
- 暂存区识别定位：到达大致位置后借助视觉进行微调
- 放置原料：按照顺序放置（码垛放置，颜色相同）

##### 返回和结束
- 回到起停区：考虑是否需要旋转，如何入库（需要考虑总时间，需要在3分钟内完成）

### 各自模块和功能的逻辑实现
主要参见各个模块下对应的README.md文件